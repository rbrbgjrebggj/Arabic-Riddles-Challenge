<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>موقع الألغاز الشعبية - عبد العزيز</title>
    
    <!-- رؤوس الأمان المطلوبة -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; img-src 'self' data: https://images.unsplash.com; font-src 'self' https://fonts.gstatic.com; frame-src 'none'; object-src 'none';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), camera=(), microphone=()">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* أنماط CSS الأصلية هنا بدون تغيير */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* ... (بقية الأنماط تبقى كما هي) ... */
    </style>
</head>
<body>
    <div class="folk-pattern pattern-1"></div>
    <div class="folk-pattern pattern-2"></div>
    
    <!-- رأس الموقع -->
    <header class="site-header">
        <h1>موقع الألغاز الشعبية</h1>
        <p>استمتع بأفضل الألعاب الشعبية والتحديات الذهنية الممتعة، اختبر ذكاءك وتحدى أصدقاءك!</p>
    </header>

    <!-- قائمة التنقل -->
    <nav class="site-nav">
        <ul>
            <li><a href="#" class="nav-link active" data-target="home">الرئيسية</a></li>
            <li><a href="#" class="nav-link" data-target="games">الألعاب</a></li>
            <li><a href="#" class="nav-link" data-target="about">من نحن</a></li>
            <li><a href="#" class="nav-link" data-target="contact">اتصل بنا</a></li>
        </ul>
    </nav>

    <!-- المحتوى الرئيسي -->
    <div class="main-content">
        <!-- الصفحة الرئيسية -->
        <section id="home" class="page-section active">
            <h2 class="section-title">مرحباً بكم في موقع الألغاز الشعبية</h2>
            
            <div class="about-content">
                <div class="about-text">
                    <p>موقعنا هو وجهتك المثالية لمحبي الألغاز والألعاب الشعبية التقليدية. نقدم لكم تجربة فريدة وممتعة تجمع بين التحدي الذهني والمتعة.</p>
                    <p>تم تطوير هذا الموقع بعناية ليوفر لكم أفضل الألعاب الشعبية التي تناسب جميع الأعمار، مع الحفاظ على الأصالة والتراث العربي الأصيل.</p>
                    <p>استمتع بتحدي أصدقائك واختبر مهاراتك الذهنية مع ألعابنا المبتكرة والممتعة. يمكنك اللعب بمفردك أو مع الأصدقاء لخلق جو من المنافسة الشريفة والمتعة.</p>
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="play-btn" onclick="showPage('games')">
                            <i class="fas fa-gamepad"></i> تصفح الألعاب
                        </button>
                    </div>
                </div>
                
                <div class="about-image">
                    <img src="https://images.unsplash.com/photo-1511512578047-dfb367046420?auto=format&fit=crop&w=600&h=400&q=80" alt="صورة عن الألغاز الشعبية" crossorigin="anonymous">
                </div>
            </div>
        </section>
        
        <!-- صفحة الألعاب -->
        <section id="games" class="page-section">
            <h2 class="section-title">ألعابنا الشعبية</h2>
            
            <div class="games-grid">
                <!-- لعبة الألغاز -->
                <div class="game-card">
                    <div class="game-icon">
                        <i class="fas fa-puzzle-piece"></i>
                    </div>
                    <h3>الألغاز الشعبية</h3>
                    <p>اختبر ذكاءك مع مجموعة رائعة من الألغاز الشعبية الممتعة. كل لغز هو تحدي جديد يتطلب التفكير الإبداعي والذكاء.</p>
                    <button class="play-btn" onclick="showGame()">
                        <i class="fas fa-play"></i> العب الآن
                    </button>
                </div>
                
                <!-- لعبة الذكاء -->
                <div class="game-card">
                    <div class="game-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h3>تحدي الذكاء</h3>
                    <p>اختبر قدراتك الذهنية مع أسئلة متنوعة في الرياضيات والمنطق والتفكير الإبداعي. كل سؤال هو فرصة لتحسين مهاراتك.</p>
                    <button class="play-btn">
                        <i class="fas fa-play"></i> قريباً
                    </button>
                </div>
                
                <!-- لعبة الكلمات -->
                <div class="game-card">
                    <div class="game-icon">
                        <i class="fas fa-font"></i>
                    </div>
                    <h3>تحدي الكلمات</h3>
                    <p>اكتشف الكلمات المخفية في الشبكة. كلما وجدت كلمات أكثر، كلما زادت نقاطك. تحدى نفسك ووسع مفرداتك اللغوية.</p>
                    <button class="play-btn">
                        <i class="fas fa-play"></i> قريباً
                    </button>
                </div>

                <!-- لعبة الذاكرة -->
                <div class="game-card">
                    <div class="game-icon">
                        <i class="fas fa-memory"></i>
                    </div>
                    <h3>لعبة الذاكرة</h3>
                    <p>اختبر ذاكرتك وقدرتك على التركيز في هذه اللعبة الممتعة. ابحث عن الصور المتطابقة وحاول إكمال اللعبة بأقل عدد من المحاولات.</p>
                    <button class="play-btn">
                        <i class="fas fa-play"></i> قريباً
                    </button>
                </div>
            </div>
        </section>
        
        <!-- صفحة من نحن -->
        <section id="about" class="page-section">
            <h2 class="section-title">من نحن</h2>
            
            <div class="about-content">
                <div class="about-image">
                    <img src="https://images.unsplash.com/photo-1543269865-cbf427effbad?auto=format&fit=crop&w=600&h=400&q=80" alt="فريق العمل" crossorigin="anonymous">
                </div>
                
                <div class="about-text">
                    <p>نحن فريق من عشاق الألعاب الشعبية والتراث العربي، نسعى للحفاظ على هذا الإرث الثقافي وتقديمه للأجيال الجديدة بطريقة عصرية وممتعة.</p>
                    <p>تأسس موقعنا في عام 2025 بهدف إحياء الألعاب الشعبية التقليدية وتقديمها بشكل رقمي يتناسب مع العصر الحديث، مع الحفاظ على روحها الأصيلة.</p>
                    <p>رسالتنا هي تقديم تجربة لعب تعليمية ترفيهية تجمع بين المتعة والفائدة، وتعزز التفكير الإبداعي والمنطقي لدى اللاعبين من جميع الأعمار.</p>
                    <h3 style="color: #8b4513; margin-top: 20px; border-bottom: 2px solid #d4a017; padding-bottom: 10px;">قيمنا:</h3>
                    <ul style="list-style-type: none; padding-right: 20px;">
                        <li style="margin-bottom: 10px; font-size: 1.1em;"><i class="fas fa-star" style="color: #d4a017; margin-left: 10px;"></i> الحفاظ على التراث الشعبي</li>
                        <li style="margin-bottom: 10px; font-size: 1.1em;"><i class="fas fa-star" style="color: #d4a017; margin-left: 10px;"></i> تقديم محتوى تعليمي ممتع</li>
                        <li style="margin-bottom: 10px; font-size: 1.1em;"><i class="fas fa-star" style="color: #d4a017; margin-left: 10px;"></i> الابتكار والتطوير المستمر</li>
                        <li style="margin-bottom: 10px; font-size: 1.1em;"><i class="fas fa-star" style="color: #d4a017; margin-left: 10px;"></i> الجودة والتميز في التصميم</li>
                    </ul>
                </div>
            </div>
        </section>
        
        <!-- صفحة اتصل بنا -->
        <section id="contact" class="page-section">
            <h2 class="section-title">اتصل بنا</h2>
            
            <div class="contact-form">
                <form id="contactForm">
                    <!-- حماية CSRF -->
                    <input type="hidden" id="csrf_token" name="csrf_token">
                    
                    <div class="form-group">
                        <label for="name">اسمك الكريم</label>
                        <input type="text" id="name" placeholder="أدخل اسمك" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">البريد الإلكتروني</label>
                        <input type="email" id="email" placeholder="أدخل بريدك الإلكتروني" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="subject">الموضوع</label>
                        <select id="subject" required>
                            <option value="">اختر الموضوع</option>
                            <option value="support">الدعم الفني</option>
                            <option value="suggestion">مقترحات</option>
                            <option value="partnership">شراكات</option>
                            <option value="other">استفسارات أخرى</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="message">رسالتك</label>
                        <textarea id="message" placeholder="أدخل رسالتك هنا..." required></textarea>
                    </div>
                    
                    <button type="submit" class="submit-btn">إرسال الرسالة</button>
                </form>
                
                <div style="margin-top: 40px; text-align: center;">
                    <h3 style="color: #8b4513; margin-bottom: 20px;">معلومات الاتصال</h3>
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 30px;">
                        <div style="background: #fff9e6; padding: 20px; border-radius: 15px; border: 2px solid #d4a017; min-width: 250px;">
                            <i class="fas fa-envelope" style="font-size: 2em; color: #8b4513; margin-bottom: 15px;"></i>
                            <h4 style="color: #8b4513;">البريد الإلكتروني</h4>
                            <p>zwza25845@gmail.com</p>
                        </div>
                        
                        <div style="background: #fff9e6; padding: 20px; border-radius: 15px; border: 2px solid #d4a017; min-width: 250px;">
                            <i class="fas fa-phone" style="font-size: 2em; color: #8b4513; margin-bottom: 15px;"></i>
                            <h4 style="color: #8b4513;">قريبا</h4>
                            <p>قريبا</p>
                        </div>
                        
                        <div style="background: #fff9e6; padding: 20px; border-radius: 15px; border: 2px solid #d4a017; min-width: 250px;">
                            <i class="fas fa-map-marker-alt" style="font-size: 2em; color: #8b4513; margin-bottom: 15px;"></i>
                            <h4 style="color: #8b4513;">قريبا</h4>
                            <p>قريبا</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- لعبة الألغاز الشعبية -->
        <section id="gameContainer" class="page-section">
            <div class="game-header">
                <h2>لعبة الألغاز الشعبية</h2>
                <p>أبنشدك عن كذا كذا... تحدي الأذكياء!</p>
            </div>

            <!-- قسم إعداد اللاعبين -->
            <div id="setupSection">
                <div class="player-setup">
                    <h3><i class="fas fa-users"></i> إضافة اللاعبين</h3>
                    <div class="player-input">
                        <input type="text" id="playerName" placeholder="اسم اللاعب" maxlength="20">
                        <button onclick="addPlayer()"><i class="fas fa-user-plus"></i> إضافة لاعب</button>
                    </div>
                    <div class="players-list" id="playersList"></div>
                </div>
                <button class="start-btn" id="startBtn" onclick="startGame()" disabled>
                    <i class="fas fa-rocket"></i> ابدأ التحدي
                </button>
            </div>

            <!-- قسم اللعبة -->
            <div id="gamePlaySection" style="display: none;">
                <div class="timer-container">
                    <div class="timer-display" id="timerDisplay">02:00</div>
                    <div class="timer-label">دقيقتين متبقيتين</div>
                </div>

                <div class="game-board">
                    <div class="scoreboard" id="scoreboard">
                        <h3><i class="fas fa-clipboard-list"></i> اللاعبون</h3>
                        <div id="scoresContainer"></div>
                    </div>
                    
                    <div class="leaderboard" id="leaderboard">
                        <h3><i class="fas fa-trophy"></i> الترتيب</h3>
                        <div id="leaderboardList"></div>
                    </div>
                </div>

                <div class="riddle-box">
                    <div class="riddle-text" id="riddleText"></div>
                    <div class="answer-section">
                        <input type="text" class="answer-input" id="answerInput" placeholder="اكتب الإجابة هنا...">
                        <div class="btn-group">
                            <button class="answer-btn" onclick="checkAnswer()">
                                <i class="fas fa-check-circle"></i> تأكيد الإجابة
                            </button>
                            <button class="answer-btn skip-btn" onclick="skipRiddle()">
                                <i class="fas fa-forward"></i> تخطي السؤال
                            </button>
                        </div>
                        <div class="feedback" id="feedback"></div>
                        <button class="next-btn" id="nextBtn" onclick="nextPlayer()" style="display: none;">
                            <i class="fas fa-arrow-right"></i> اللاعب التالي
                        </button>
                    </div>
                </div>
            </div>

            <!-- نهاية اللعبة -->
            <div class="game-over" id="gameOver">
                <div class="winner-announcement" id="winnerText"></div>
                <div class="final-scores" id="finalScores"></div>
                <button class="restart-btn" onclick="restartGame()">
                    <i class="fas fa-redo-alt"></i> لعبة جديدة
                </button>
            </div>
        </section>
    </div>

    <!-- تذييل الموقع -->
    <footer class="site-footer">
        <p>شارك الموقع مع أصدقائك وتحداهم في لعبة الألغاز الشعبية!</p>
        <p>للإقتراحات أو الاستفسارات: zwza25845@gmail.com</p>
        
        <div class="social-links">
            <a href="#" rel="noopener noreferrer"><i class="fab fa-twitter"></i></a>
            <a href="#" rel="noopener noreferrer"><i class="fab fa-instagram"></i></a>
            <a href="#" rel="noopener noreferrer"><i class="fab fa-youtube"></i></a>
            <a href="#" rel="noopener noreferrer"><i class="fab fa-tiktok"></i></a>
        </div>
        
        <div class="copyright">
            جميع الحقوق محفوظة &copy; 2025 - عبد العزيز
        </div>
    </footer>

    <script>
        // توليد رمز CSRF لمنع هجمات التزوير
        function generateCSRFToken() {
            const token = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('csrf_token', token);
            return token;
        }
        
        // تنقية المدخلات لمنع هجمات XSS
        function sanitizeInput(input) {
            return input
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;')
                .replace(/\//g, '&#x2F;');
        }
        
        // تحقق من روابط التوجيه لمنع Open Redirect
        function validateRedirectUrl(url) {
            const allowedDomains = ['yourdomain.com', 'trusted-site.com'];
            const domain = new URL(url).hostname;
            
            if (!allowedDomains.includes(domain)) {
                return '/'; // الصفحة الرئيسية
            }
            return url;
        }
        
        // تهيئة رمز CSRF عند تحميل الصفحة
        if (!localStorage.getItem('csrf_token')) {
            generateCSRFToken();
        }
        document.getElementById('csrf_token').value = localStorage.getItem('csrf_token');

        // التنقل بين الصفحات
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = this.getAttribute('data-target');
                
                // تحديث القائمة النشطة
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // إظهار الصفحة المحددة
                document.querySelectorAll('.page-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(target).classList.add('active');
            });
        });

        // إظهار لعبة الألغاز
        function showGame() {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('gameContainer').classList.add('active');
            
            // إعادة تعيين اللعبة
            restartGame();
        }

        // بيانات اللعبة
        let players = [];
        let currentPlayerIndex = 0;
        let scores = {};
        let currentRiddleIndex = 0;
        let gameRounds = 0;
        let timer = 120; // 120 ثانية = دقيقتين
        let timerInterval;
        let gameActive = false;
        const maxRounds = 10;

        // مجموعة الألغاز الشعبية
        const riddles = [
            {
                question: "أبنشدك عن بيت له باب واحد، وله مية باب وله ألف باب، وله ألف ألف باب، وما يدخله إلا الطيب",
                answer: "المسجد"
            },
            {
                question: "أبنشدك عن شيء يضيء الطريق وما يشوف",
                answer: "المصباح"
            },
            {
                question: "أبنشدك عن شيء أبيض كالثلج، أسود كالليل، أحمر كالدم، أصفر كالذهب",
                answer: "الكتاب"
            },
            {
                question: "أبنشدك عن شيء يمشي وما له رجلين، ويطير وما له جناحين، ويسمع وما له أذنين",
                answer: "الصوت"
            },
            {
                question: "أبنشدك عن شيء كل يوم يكبر، وكل سنة يصغر",
                answer: "العمر"
            },
            {
                question: "أبنشدك عن شيء له عيون وما يشوف، وله رقبة وما له رأس",
                answer: "الابريق"
            },
            {
                question: "أبنشدك عن شيء يقرص وما له أسنان، ويعض وما له فم",
                answer: "البرد"
            },
            {
                question: "أبنشدك عن شيء إذا أكلته كله تموت، وإذا أكلت نصه تعيش",
                answer: "السمسم"
            },
            {
                question: "أبنشدك عن شيء يسقط وما يتكسر، ويتكسر وما يسقط",
                answer: "الثلج"
            },
            {
                question: "أبنشدك عن شيء له جسم وما له روح، وله صوت وما له فم",
                answer: "الجرس"
            },
            {
                question: "أبنشدك عن شيء كلما زاد نقص، وكلما نقص زاد",
                answer: "الحفره"
            },
            {
                question: "أبنشدك عن شيء يولد في البحر ويموت في البر",
                answer: "الملح"
            },
            {
                question: "أبنشدك عن شيء أسود وأبيض وأحمر في كل مكان",
                answer: "الجريدة"
            },
            {
                question: "أبنشدك عن شيء له رأس وما له شعر، وله عيون وما يبصر",
                answer: "الابره"
            },
            {
                question: "أبنشدك عن شيء يدور حول البيت وما يدخله",
                answer: "الطريق"
            }
        ];

        // إضافة لاعب جديد
        function addPlayer() {
            let playerName = document.getElementById('playerName').value.trim();
            if (playerName) {
                // تنظيف المدخلات لمنع XSS
                playerName = sanitizeInput(playerName);
                
                if (!players.includes(playerName)) {
                    players.push(playerName);
                    scores[playerName] = 0;
                    updatePlayersList();
                    document.getElementById('playerName').value = '';
                    
                    if (players.length >= 2) {
                        document.getElementById('startBtn').disabled = false;
                    }
                }
            }
        }

        // تحديث قائمة اللاعبين
        function updatePlayersList() {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            players.forEach((player, index) => {
                const playerTag = document.createElement('div');
                playerTag.className = 'player-tag';
                playerTag.innerHTML = `${index + 1}. ${player} 
                    <span class="remove-btn" onclick="removePlayer('${player}')">✕</span>`;
                playersList.appendChild(playerTag);
            });
        }

        // إزالة لاعب
        function removePlayer(playerName) {
            players = players.filter(player => player !== playerName);
            delete scores[playerName];
            updatePlayersList();
            
            if (players.length < 2) {
                document.getElementById('startBtn').disabled = true;
            }
        }

        // بدء اللعبة
        function startGame() {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('gamePlaySection').style.display = 'block';
            document.getElementById('gameOver').style.display = 'none';
            
            currentPlayerIndex = 0;
            gameRounds = 0;
            currentRiddleIndex = 0;
            gameActive = true;
            
            // خلط الألغاز
            shuffleArray(riddles);
            
            updateScoreboard();
            updateLeaderboard();
            showCurrentRiddle();
            startTimer();
        }

        // خلط المصفوفة
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // بدء العداد الزمني (دقيقتين كاملتين)
        function startTimer() {
            timer = 120;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timer--;
                updateTimerDisplay();
                
                if (timer <= 30) {
                    document.querySelector('.timer-container').style.animation = 'pulse 1s infinite';
                }
                
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    timeUp();
                }
            }, 1000);
        }

        // تحديث عرض العداد (بتنسيق mm:ss)
        function updateTimerDisplay() {
            const minutes = Math.floor(timer / 60);
            const seconds = timer % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // انتهاء الوقت
        function timeUp() {
            if (!gameActive) return;
            
            const feedback = document.getElementById('feedback');
            feedback.textContent = `⏰ انتهى الوقت! الإجابة الصحيحة كانت: ${riddles[currentRiddleIndex].answer}`;
            feedback.className = 'feedback incorrect';
            
            document.getElementById('answerInput').disabled = true;
            document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
            document.getElementById('nextBtn').style.display = 'inline-block';
            
            currentRiddleIndex++;
            
            if (gameRounds >= maxRounds) {
                setTimeout(endGame, 2000);
            }
        }

        // تحديث لوحة النقاط
        function updateScoreboard() {
            const scoresContainer = document.getElementById('scoresContainer');
            scoresContainer.innerHTML = '';
            
            players.forEach((player, index) => {
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                if (index === currentPlayerIndex) {
                    scoreItem.classList.add('current-player');
                }
                scoreItem.innerHTML = `<span>${player}</span> <span>${scores[player]} نقطة</span>`;
                scoresContainer.appendChild(scoreItem);
            });
        }

        // تحديث لوحة الترتيب
        function updateLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';
            
            // ترتيب اللاعبين حسب النقاط
            const sortedPlayers = [...players].sort((a, b) => scores[b] - scores[a]);
            
            sortedPlayers.forEach((player, index) => {
                const leaderItem = document.createElement('div');
                leaderItem.className = 'leader-item';
                if (index < 3) {
                    leaderItem.classList.add('top-player');
                }
                
                let rankSymbol = '';
                if (index === 0) rankSymbol = '🥇';
                else if (index === 1) rankSymbol = '🥈';
                else if (index === 2) rankSymbol = '🥉';
                
                leaderItem.innerHTML = `
                    <span>${rankSymbol} ${index + 1}. ${player}</span>
                    <span>${scores[player]} نقطة</span>
                `;
                leaderboardList.appendChild(leaderItem);
            });
        }

        // عرض اللغز الحالي
        function showCurrentRiddle() {
            if (currentRiddleIndex >= riddles.length) {
                currentRiddleIndex = 0;
                shuffleArray(riddles);
            }
            
            const riddle = riddles[currentRiddleIndex];
            document.getElementById('riddleText').textContent = riddle.question;
            document.getElementById('answerInput').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = '';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('answerInput').disabled = false;
            document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = false);
            document.querySelector('.timer-container').style.animation = 'none';
            
            // التركيز على حقل الإدخال
            setTimeout(() => {
                document.getElementById('answerInput').focus();
            }, 300);
            
            startTimer();
        }

        // فحص الإجابة
        function checkAnswer() {
            if (!gameActive) return;
            
            clearInterval(timerInterval);
            let userAnswer = document.getElementById('answerInput').value.trim();
            const correctAnswer = riddles[currentRiddleIndex].answer;
            const feedback = document.getElementById('feedback');
            
            // تنظيف الإجابة قبل المقارنة
            userAnswer = sanitizeInput(userAnswer);
            
            if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                feedback.textContent = `🎉 إجابة صحيحة! ${players[currentPlayerIndex]} حصل على نقطة!`;
                feedback.className = 'feedback correct';
                scores[players[currentPlayerIndex]]++;
            } else {
                feedback.textContent = `❌ إجابة خاطئة! الإجابة الصحيحة هي: ${correctAnswer}`;
                feedback.className = 'feedback incorrect';
            }
            
            document.getElementById('answerInput').disabled = true;
            document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
            document.getElementById('nextBtn').style.display = 'inline-block';
            
            updateScoreboard();
            updateLeaderboard();
            currentRiddleIndex++;
            
            // فحص انتهاء اللعبة
            if (gameRounds >= maxRounds) {
                setTimeout(endGame, 2000);
            }
        }

        // تخطي اللغز
        function skipRiddle() {
            if (!gameActive) return;
            
            clearInterval(timerInterval);
            const feedback = document.getElementById('feedback');
            feedback.textContent = `⏭️ تم تخطي اللغز! الإجابة كانت: ${riddles[currentRiddleIndex].answer}`;
            feedback.className = 'feedback incorrect';
            
            document.getElementById('answerInput').disabled = true;
            document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
            document.getElementById('nextBtn').style.display = 'inline-block';
            
            currentRiddleIndex++;
            
            if (gameRounds >= maxRounds) {
                setTimeout(endGame, 2000);
            }
        }

        // اللاعب التالي
        function nextPlayer() {
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            if (currentPlayerIndex === 0) {
                gameRounds++;
            }
            
            if (gameRounds < maxRounds) {
                updateScoreboard();
                updateLeaderboard();
                showCurrentRiddle();
            } else {
                endGame();
            }
        }

        // انتهاء اللعبة
        function endGame() {
            gameActive = false;
            clearInterval(timerInterval);
            
            document.getElementById('gamePlaySection').style.display = 'none';
            document.getElementById('gameOver').style.display = 'block';
            
            // العثور على الفائز
            let winner = '';
            let maxScore = -1;
            let isTie = false;
            let winners = [];
            
            for (const player in scores) {
                if (scores[player] > maxScore) {
                    maxScore = scores[player];
                    winner = player;
                    winners = [player];
                } else if (scores[player] === maxScore) {
                    winners.push(player);
                    isTie = true;
                }
            }
            
            if (isTie) {
                document.getElementById('winnerText').textContent = `تعادل! الفائزون: ${winners.join('، ')} 🏆`;
            } else {
                document.getElementById('winnerText').textContent = `الفائز: ${winner} 🏆`;
            }
            
            // عرض النتائج النهائية
            const finalScoresContainer = document.getElementById('finalScores');
            finalScoresContainer.innerHTML = '<h3>النتائج النهائية:</h3>';
            
            // ترتيب اللاعبين حسب النقاط
            const sortedPlayers = Object.entries(scores).sort((a, b) => b[1] - a[1]);
            
            sortedPlayers.forEach(([player, score], index) => {
                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'leader-item top-player';
                
                let rankSymbol = '';
                if (index === 0) rankSymbol = '🥇';
                else if (index === 1) rankSymbol = '🥈';
                else if (index === 2) rankSymbol = '🥉';
                
                scoreDiv.innerHTML = `
                    <span>${rankSymbol} ${index + 1}. ${player}</span>
                    <span>${score} نقطة</span>
                `;
                finalScoresContainer.appendChild(scoreDiv);
            });
        }

        // إعادة بدء اللعبة
        function restartGame() {
            gameActive = false;
            clearInterval(timerInterval);
            
            players = [];
            scores = {};
            currentPlayerIndex = 0;
            currentRiddleIndex = 0;
            gameRounds = 0;
            
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('gamePlaySection').style.display = 'none';
            document.getElementById('playersList').innerHTML = '';
            document.getElementById('startBtn').disabled = true;
            document.getElementById('playerName').value = '';
        }

        // إضافة مستمعي الأحداث
        document.getElementById('playerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addPlayer();
            }
        });

        document.getElementById('answerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && gameActive) {
                checkAnswer();
            }
        });

        // نموذج الاتصال
        document.getElementById('contactForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // تحقق من رمز CSRF
            const formToken = document.getElementById('csrf_token').value;
            const storedToken = localStorage.getItem('csrf_token');
            
            if (formToken !== storedToken) {
                alert('رمز الأمان غير صالح! يرجى تحديث الصفحة والمحاولة مرة أخرى.');
                return;
            }
            
            // هنا يمكنك إضافة كود إرسال النموذج
            alert('تم إرسال رسالتك بنجاح! سنتواصل معك في أقرب وقت.');
            this.reset();
            
            // إنشاء رمز CSRF جديد بعد كل إرسال
            document.getElementById('csrf_token').value = generateCSRFToken();
        });
    </script>
</body>
</html>
